<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Compilador de Escudos ‚Äî escudos.mind</title>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>
    <style>
      *,*::before,*::after{box-sizing:border-box}
      body{margin:0;min-height:100vh;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);font-family:Arial,sans-serif;color:#e2e8f0;padding:32px 16px}
      .container{max-width:700px;margin:0 auto}
      h1{font-size:28px;font-weight:900;color:#fff;margin:0 0 8px}
      .subtitle{color:#c4b5fd;font-size:14px;margin-bottom:32px}
      .drop-zone{border:2px dashed #7c3aed;border-radius:16px;padding:40px 20px;text-align:center;cursor:pointer;transition:background .2s;background:rgba(124,58,237,.05);margin-bottom:24px}
      .drop-zone:hover,.drop-zone.dragover{background:rgba(124,58,237,.12);border-color:#a78bfa}
      .drop-zone .icon{font-size:48px;margin-bottom:12px}
      .drop-zone p{margin:0 0 6px;font-size:16px;font-weight:700;color:#fff}
      .drop-zone small{color:#a78bfa;font-size:12px}
      #fileInput{display:none}
      #previewGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-bottom:24px}
      .thumb{position:relative;border-radius:10px;overflow:hidden;border:2px solid #4c1d95;background:#1e1b4b;aspect-ratio:1}
      .thumb img{width:100%;height:100%;object-fit:cover;display:block}
      .thumb .remove{position:absolute;top:2px;right:2px;width:20px;height:20px;background:rgba(239,68,68,.85);border:none;border-radius:50%;color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:900;line-height:1}
      .thumb .idx{position:absolute;bottom:2px;left:4px;font-size:10px;background:rgba(0,0,0,.6);border-radius:4px;padding:1px 4px;color:#c4b5fd;font-weight:700}
      #compileBtn{width:100%;padding:14px;font-size:16px;font-weight:700;border:none;border-radius:999px;cursor:pointer;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;box-shadow:0 4px 20px rgba(124,58,237,.4);margin-bottom:16px;transition:opacity .2s,transform .15s}
      #compileBtn:disabled{opacity:.5;cursor:not-allowed}
      #compileBtn:hover:not(:disabled){transform:scale(1.02)}
      #progressWrap{display:none;margin-bottom:16px}
      .progress-bar-bg{background:#1e1b4b;border-radius:999px;height:10px;overflow:hidden;margin-bottom:6px}
      #progressBar{height:100%;width:0%;background:linear-gradient(90deg,#7c3aed,#a78bfa);border-radius:999px;transition:width .3s}
      #progressLabel{font-size:13px;color:#a78bfa;text-align:center}
      #result{display:none;padding:20px;border-radius:14px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);text-align:center;margin-bottom:16px}
      #result p{margin:0 0 12px;font-size:15px}
      .dl-btn{display:inline-block;background:linear-gradient(135deg,#059669,#047857);color:#fff;padding:11px 24px;border-radius:999px;font-weight:700;text-decoration:none;font-size:14px}
      .info-box{background:rgba(124,58,237,.08);border:1px solid rgba(124,58,237,.25);border-radius:12px;padding:16px 20px;font-size:13px;color:#c4b5fd;line-height:1.7}
      .info-box strong{color:#fff}
      .info-box ol{margin:8px 0 0;padding-left:18px}
      a.home-link{display:inline-block;margin-bottom:20px;color:#a78bfa;font-size:13px;text-decoration:none;font-weight:600}
      a.home-link:hover{color:#c4b5fd}
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/" class="home-link">‚Üê Volver a la app</a>
      <h1>üõ†Ô∏è Compilador de Escudos</h1>
      <p class="subtitle">Convierte tus imagenes de escudos en el archivo <code>escudos.mind</code> que usa MindAR.</p>

      <div class="drop-zone" id="dropZone">
        <div class="icon">üñºÔ∏è</div>
        <p>Arrastra las imagenes de escudos aqui</p>
        <small>o haz clic para seleccionar ‚Äî PNG / JPG / WEBP</small>
        <input type="file" id="fileInput" accept="image/png,image/jpeg,image/webp" multiple />
      </div>

      <div id="previewGrid"></div>
      <button id="compileBtn" disabled>Compilar escudos.mind</button>

      <div id="progressWrap">
        <div class="progress-bar-bg"><div id="progressBar"></div></div>
        <div id="progressLabel">Compilando imagen 0 / 0...</div>
      </div>

      <div id="result">
        <p>‚úÖ <strong>Compilacion completada.</strong><br>Descarga el archivo y reemplaza <code>public/targets/escudos.mind</code> en tu proyecto.</p>
        <a id="dlLink" class="dl-btn" download="escudos.mind">‚¨á Descargar escudos.mind</a>
      </div>

      <div class="info-box">
        <strong>¬øComo usar este compilador?</strong>
        <ol>
          <li>Sube las imagenes de los escudos (una por equipo).</li>
          <li>Haz clic en <strong>Compilar escudos.mind</strong> y espera.</li>
          <li>Descarga el archivo y copialo a <strong>public/targets/escudos.mind</strong>.</li>
          <li>Recarga la app ‚Äî listo para escanear.</li>
        </ol>
        <br>
        üí° <strong>Consejo:</strong> Usa imagenes de alta resolucion sin fondo transparente. Escudos con colores y detalles variados funcionan mejor.
      </div>
    </div>

    <script>
      const dropZone=document.getElementById('dropZone'),fileInput=document.getElementById('fileInput'),previewGrid=document.getElementById('previewGrid'),compileBtn=document.getElementById('compileBtn'),progressWrap=document.getElementById('progressWrap'),progressBar=document.getElementById('progressBar'),progressLabel=document.getElementById('progressLabel'),result=document.getElementById('result'),dlLink=document.getElementById('dlLink');
      let images=[];

      dropZone.addEventListener('click',()=>fileInput.click());
      dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('dragover')});
      dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('dragover'));
      dropZone.addEventListener('drop',e=>{e.preventDefault();dropZone.classList.remove('dragover');addFiles([...e.dataTransfer.files])});
      fileInput.addEventListener('change',()=>{addFiles([...fileInput.files]);fileInput.value=''});

      function addFiles(files){
        files.filter(f=>f.type.startsWith('image/')).forEach(f=>{
          const r=new FileReader();
          r.onload=e=>{images.push({file:f,dataUrl:e.target.result});renderPreviews()};
          r.readAsDataURL(f);
        });
      }

      function renderPreviews(){
        previewGrid.innerHTML='';
        images.forEach((img,i)=>{
          const d=document.createElement('div');d.className='thumb';
          d.innerHTML=`<img src="${img.dataUrl}" alt="Escudo ${i}"/><button class="remove" data-i="${i}">√ó</button><span class="idx">#${i}</span>`;
          previewGrid.appendChild(d);
        });
        previewGrid.querySelectorAll('.remove').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();images.splice(parseInt(b.dataset.i),1);renderPreviews()}));
        compileBtn.disabled=images.length===0;
        result.style.display='none';
      }

      compileBtn.addEventListener('click',async()=>{
        if(!images.length)return;
        compileBtn.disabled=true;
        progressWrap.style.display='block';
        result.style.display='none';
        progressBar.style.width='0%';
        progressLabel.textContent='Procesando 0 / '+images.length+'...';
        try{
          const htmlImgs=await Promise.all(images.map(({dataUrl})=>new Promise((res,rej)=>{const img=new Image();img.onload=()=>res(img);img.onerror=rej;img.src=dataUrl})));
          const compiler=new MINDAR.IMAGE.Compiler();
          await compiler.compileImageTargets(htmlImgs,p=>{const pct=Math.round(p*100);progressBar.style.width=pct+'%';progressLabel.textContent='Compilando... '+pct+'%'});
          const buffer=await compiler.exportData();
          const blob=new Blob([buffer],{type:'application/octet-stream'});
          dlLink.href=URL.createObjectURL(blob);
          result.style.display='block';
          progressLabel.textContent='Listo! Descarga el archivo abajo.';
        }catch(e){console.error(e);progressLabel.textContent='Error durante la compilacion. Revisa la consola.'}
        finally{compileBtn.disabled=false}
      });
    </script>
  </body>
</html>
